# Reposter

## Описание

`Reposter` — это автоматизированный инструмент для синхронизации и репостинга контента между социальными сетями VK.com и Telegram. Приложение периодически проверяет новые публикации в указанных источниках VK, обрабатывает их (включая загрузку медиафайлов с помощью yt-dlp) и публикует в целевые каналы Telegram. Поддерживается гибкая настройка правил репостинга и параметров загрузки.

## Возможности

* **Автоматический мониторинг:** Периодическая проверка новых постов в VK (со стен групп или из VK Donut).
* **Гибкие правила репостинга:** Настройка связок (bindings) между источниками VK и целевыми каналами Telegram.
* **Обработка медиа:** Загрузка видео и аудио с различных платформ (через yt-dlp) и их последующая публикация.
* **Поддержка Telegram:** Отправка текстовых сообщений, фото, видео, аудио и документов в каналы Telegram.
* **Управление сессиями:** Использование сессионных файлов для Telegram для сохранения авторизации.
* **Настраиваемые параметры:** Все ключевые параметры работы приложения задаются через файл `config.yaml`.

## Установка

Вы также можете скачать готовое приложение из раздела [Релизы](https://github.com/your-username/reposter/releases).

1. **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/your-username/reposter.git
    cd reposter
    ```

2. **Создайте виртуальное окружение и установите зависимости:**
    Используйте `uv` (рекомендуется) или `pip`:

    **С помощью uv:**

    ```bash
    uv venv
    source .venv/bin/activate # Linux/macOS
    .venv\Scripts\activate # Windows
    uv pip install -e .
    ```

    **С помощью pip:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate # Linux/macOS
    .venv\Scripts\activate # Windows
    pip install -e .
    ```

## Конфигурация

Основная конфигурация проекта находится в файле `config.yaml`. Создайте этот файл в корневой директории проекта, если его нет, и заполните его следующими данными. Некоторые параметры также могут быть заданы через переменные окружения.

```sh
# Пример .env
# --- Основные токены и ключи (могут быть также заданы через переменные окружения) ---
VK_SERVICE_TOKEN: Ваш сервисный ключ доступа VK
TELEGRAM_API_ID: Ваш API ID для Telegram
TELEGRAM_API_HASH: Ваш API Hash для Telegram
```

```yaml
# Пример config.yaml
# --- Настройки приложения ---
app:
  wait_time_seconds: 600 # Интервал между проверками новых постов (в секундах). Минимум 1.
  state_file: state.yaml # Имя файла для сохранения состояния приложения (например, ID последних постов).
  session_name: user_session # Имя сессии Pyrogram для Telegram.

# --- Правила репостинга (список связок VK -> Telegram) ---
bindings:
  - vk:
      domain: example_vk_group # Короткое имя или ID группы/пользователя VK (например, "apiclub" или "1").
      post_count: 10 # Количество последних постов для проверки. Минимум 1.
      post_source: wall # Источник постов: "wall" (стена) или "donut" (VK Donut).
    telegram:
      channel_ids: # Список ID или @username каналов Telegram, куда будут отправляться посты.
        - -1001234567890 # Пример ID канала (начинается с -100)
        - "@my_telegram_channel" # Пример @username канала
  # - Добавьте здесь другие связки, если необходимо

# --- Настройки загрузчика медиа (yt-dlp) ---
downloader:
  browser: chrome # Браузер для получения cookie (chrome, firefox, edge).
  output_path: downloads # Путь для временных загрузок медиафайлов.
  yt_dlp_opts: # Дополнительные опции для yt-dlp (см. документацию yt-dlp).
    format: bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best
  retries:
    count: 3 # Количество попыток загрузки файла.
    delay_seconds: 10 # Задержка между попытками (в секундах).
  browser_restart_wait_seconds: 30 # Время ожидания после перезапуска браузера.
```

### Получение токенов и ключей

#### Telegram (API ID и API Hash)

Для взаимодействия с Telegram API от имени пользователя вам потребуются `api_id` и `api_hash`.

1. Перейдите на сайт [my.telegram.org](https://my.telegram.org/).
2. Войдите в свою учетную запись Telegram.
3. Нажмите "API development tools".
4. Заполните поля:
    * **App title:** `Reposter` (или любое другое название)
    * **Short name:** `reposter`
    * **Platform:** `Desktop`
    * **URL:** (можно оставить пустым)
    * **Description:** (можно оставить пустым)
5. Нажмите "Create app".
6. Вы получите `App api_id` и `App api_hash`. Скопируйте их и вставьте в `config.yaml` в соответствующие поля `TELEGRAM_API_ID` и `TELEGRAM_API_HASH` (или задайте как переменные окружения).

При первом запуске приложения с этими данными, оно запросит ваш номер телефона и код подтверждения для создания сессионного файла (имя которого задается в `app.session_name`), который будет использоваться для дальнейшей авторизации.

#### VK.com (Сервисный ключ доступа)

Для работы с VK API вам потребуется **сервисный ключ доступа** (Service Access Token). Этот ключ используется для запросов от имени приложения и не требует авторизации пользователя.

1. **Создайте Standalone-приложение:**
    * Перейдите в раздел [Мои приложения VK](https://vk.com/apps?act=manage).
    * Нажмите "Создать приложение".
    * Выберите тип "Standalone-приложение".
    * Придумайте название и нажмите "Подключить приложение".
    * В настройках приложения перейдите в раздел "Настройки".

2. **Получите сервисный ключ доступа:**
    * На странице "Настройки" вашего приложения найдите поле "Сервисный ключ доступа" (Service Access Token).
    * Скопируйте этот ключ.
    * Вставьте скопированный ключ в `config.yaml` в поле `VK_SERVICE_TOKEN` (или задайте как переменную окружения).

## Запуск

После настройки `config.yaml` вы можете запустить приложение:

```bash
uv run python -m src.reposter
```

или

```bash
uv run python main.py
```

Для запуска в режиме отладки используйте флаг `--debug`:

```bash
uv run python -m src.reposter --debug
```

## Разработка

### Запуск тестов

```bash
uv run pytest tests
```

### Проверка линтером (ruff)

```bash
uv run ruff check .
```

### Автоматическое исправление линтером (ruff)

```bash
uv run ruff check --fix .
```

### Проверка форматирования (ruff format)

```bash
uv run ruff format --check .
```

### Автоматическое исправление форматирования (ruff format)

```bash
uv run ruff format .
```

### Проверка типов (pyright)

```bash
uv run pyright
```
